name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Lint backend
        run: |
          cd backend
          pnpm lint
      
      - name: Lint frontend
        run: |
          cd frontend
          pnpm lint
      
      - name: Build contracts
        run: |
          cd contracts
          forge build
      
      - name: Test contracts
        run: |
          cd contracts
          forge test -vvv
      
      - name: Start Anvil fork
        run: |
          anvil --fork-url ${{ secrets.MAINNET_RPC_URL || 'https://eth.llamarpc.com' }} --fork-block-number 21000000 --port 8545 &
          sleep 5
        env:
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
      
      - name: Deploy contracts to fork
        run: |
          cd contracts
          forge script scripts/send-op-tx.ts:DeployScript --rpc-url http://127.0.0.1:8545 --broadcast || echo "Deploy script needs adjustment"
      
      - name: Test backend
        run: |
          cd backend
          cp .env.example .env || true
          echo "FORK_RPC_URL=http://127.0.0.1:8545" >> .env
          pnpm test
        env:
          NODE_ENV: test
      
      - name: Build backend
        run: |
          cd backend
          pnpm build
      
      - name: Build frontend
        run: |
          cd frontend
          pnpm build

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Start Anvil fork
        run: |
          anvil --fork-url ${{ secrets.MAINNET_RPC_URL || 'https://eth.llamarpc.com' }} --fork-block-number 21000000 --port 8545 &
          sleep 5
      
      - name: Run E2E tests
        run: |
          cd backend
          cp .env.example .env || true
          echo "FORK_RPC_URL=http://127.0.0.1:8545" >> .env
          pnpm test:e2e
        env:
          NODE_ENV: test
